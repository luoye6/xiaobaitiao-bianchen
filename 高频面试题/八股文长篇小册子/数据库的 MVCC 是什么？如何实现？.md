# 数据库的 MVCC 是什么？如何实现？

> 本文作者：[程序员小白条](https://github.com/luoye6)
>
> 本站地址：[https://xbt.xiaobaitiao.top](https://xbt.xiaobaitiao.top)

引用：MVCC（Multi-Version Concurrency Control，多版本并发控制）是现代数据库系统中实现高并发访问的关键技术。它通过在数据行级别维护多个版本，使得读写操作能够在不相互阻塞的情况下并发执行，从而显著提升数据库系统的吞吐量和性能。

## 解析答案

### 为什么需要 MVCC？

在传统的基于锁的并发控制机制中，读写操作之间往往存在严重的竞争关系：

1. **写阻塞读**：写操作需要获取排他锁，阻塞其他读写操作
2. **读阻塞写**：长时间的读操作会阻止写操作获取锁
3. **死锁风险**：多个事务相互等待对方释放锁资源

MVCC 通过数据版本化解决了这些问题，实现了：

- 非阻塞读取：读操作不会被写操作阻塞
- 写操作优化：写操作只需创建新版本，不影响正在进行的读操作
- 一致性视图：每个事务看到的是一致的数据库快照

### InnoDB 的 MVCC 实现机制

MVCC 的实现方式是通过为每个事务创建一个可见性版本（ Version ），而不是直接对数据进行加锁。每个版本都有一个时间戳，用于表示该版本的创建时间。当一个事务开始时，它会获得一个时间戳，并且只能看到在该时间戳之前已经提交的版本。当一个事务对数据进行修改时，会创建一个新的版本，并将该版本的时间戳设为当前时间戳。

主要依赖于：三大法宝（ 隐藏字段、Read View、undo log ）。

通过数据可见性算法（ DB_TRX_ID 事务 ID） 和 Read View （快照) 来判断数据的可见性，如果不可见，通过数据行的另一个隐藏字段 DB_ROLL_PRT（回滚指针）找到 undo log 中的历史版本。

### 读操作分类与实现

#### 快照读（Snapshot Read）

- **操作类型**：普通SELECT语句
- **实现原理**：基于第一次SELECT时创建的Read View
- **隔离级别支持**：
  - READ COMMITTED：每次SELECT创建新Read View
  - REPEATABLE READ：使用第一次SELECT的Read View

#### 当前读（Current Read）

- **操作类型**：SELECT ... FOR UPDATE、SELECT ... LOCK IN SHARE MODE、INSERT、UPDATE、DELETE
- **实现原理**：读取最新已提交数据并加锁
- **锁机制**：
  - 记录锁（Record Locks）
  - 间隙锁（Gap Locks）
  - 临键锁（Next-Key Locks）

快照读读到的是第一次查询之前所插入的数据，而当前读，每次读取的是最新数据，如果多次查询有其他事务插入，就会产生幻读的效果，因此当前读必须使用临键锁( Next-key lock )，防止幻读。

### 实战演示与验证

#### 测试环境搭建

```sql
CREATE TABLE account (
    id INT PRIMARY KEY,
    balance DECIMAL(10, 2),
    name VARCHAR(50)
) ENGINE=InnoDB;

INSERT INTO account VALUES (1, 1000.00, '程序员小白条');
```

#### 并发事务测试场景

```sql
-- 事务1：查询账户余额
START TRANSACTION;
SELECT balance FROM account WHERE id = 1;  -- 返回1000.00

-- 事务2：修改账户余额
START TRANSACTION;
UPDATE account SET balance = 1500.00 WHERE id = 1;
COMMIT;

-- 事务1再次查询（REPEATABLE READ隔离级别）
SELECT balance FROM account WHERE id = 1;  -- 仍然返回1000.00
COMMIT;
```

### 与其他并发控制机制对比

| 机制 | 优点     | 缺点     | 适用场景   |
| :--- | :------- | :------- | :--------- |
| MVCC | 高并发读 | 存储开销 | OLTP系统   |
| 2PL  | 强一致性 | 并发度低 | 银行系统   |
| OCC  | 高吞吐量 | 冲突回滚 | 高竞争场景 |

### 总结

MVCC 通过维护数据多个版本的方式，在现代数据库系统中实现了高效的并发控制。理解其实现原理和适用场景，对于设计高并发数据库应用和进行性能优化至关重要。在实际应用中，需要根据具体业务需求选择合适的隔离级别，并合理配置数据库参数以达到最佳性能表现。

程序员小白条的编程日记：https://xbt.xiaobaitiao.top/ （分享如何拿到腾讯实习 Offer 和多个中大厂的面试机会，大学经历、求职经历、职场工作、创作经历、生活日常、面经、技术分享）定期更新内容，成长打怪系列，分享从大一到大四的完整面经，看完可冲中大厂！dy同名程序员小白条，主要口述面试经历和分享我认为的实用网站，会比面经讲的详细很多，以真实面试录音为主！公粽号：**程序员落叶（全部面经和面试技巧）**

**欢迎关注上方公众号！感谢支持！一起进步，共勉！**

## 欢迎交流

在阅读本文后，你应该对 MVCC 是什么？以及 MVCC 是怎么样实现的有了基本的概念，你应该向自己进行提问，并且层层递进，接下来我放出三个问题，欢迎大家在评论区交流自己的见解。

1）MVCC 中，如何处理多个事务对同一对象进行写操作的情况？

2）MVCC 在哪些场景下比传统的并发控制方法有效？

3）MVCC 是如何保证数据的一致性的？